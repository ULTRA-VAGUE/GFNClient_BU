# --- RELEASE SYNC (OPTIMIZED VERSION) ---
      - name: Sync latest releases + assets
        env:
          TOKEN: ${{ secrets.UPSTREAM_SYNC_PAT }}
          REPO_FORK: ${{ github.repository }}
        run: |
          echo "Fetching latest releases (max $MAX_RELEASES)‚Ä¶"

          # 1. Download mit API-Limitierung (?per_page=...)
          # Das verhindert riesige Dateien und Abbruchfehler
          curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/releases?per_page=${MAX_RELEASES}" \
            -o releases.json

          # 2. Sicherheitscheck: Dateiinhalt pr√ºfen bei Fehler
          if ! jq -e . releases.json >/dev/null 2>&1; then
            echo "‚ùå CRITICAL ERROR: Invalid JSON received."
            echo "--- FILE CONTENT START ---"
            cat releases.json
            echo "--- FILE CONTENT END ---"
            exit 1
          fi

          # 3. Verarbeitung (Vereinfacht)
          cat releases.json | jq -c '.[]' | while read rel; do
            TAG=$(echo "$rel" | jq -r '.tag_name')
            NAME=$(echo "$rel" | jq -r '.name')
            BODY=$(echo "$rel" | jq -r '.body' | jq -Rs .)
            DRAFT=$(echo "$rel" | jq -r '.draft')
            PRERELEASE=$(echo "$rel" | jq -r '.prerelease')

            echo "‚û°Ô∏è Syncing release $TAG"

            # Check if release exists on fork
            EXISTING=$(curl -s -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/${REPO_FORK}/releases/tags/$TAG)

            # Determine RELEASE_ID
            if [[ "$(echo "$EXISTING" | jq -r '.id')" == "null" ]]; then
              echo "üÜï Creating fork release $TAG‚Ä¶"
              RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"tag_name\":\"$TAG\",\"name\":\"$NAME\",\"body\":$BODY,\"draft\":$DRAFT,\"prerelease\":$PRERELEASE}" \
                https://api.github.com/repos/${REPO_FORK}/releases)
            else
              echo "‚úîÔ∏è Updating fork release $TAG‚Ä¶"
              RELEASE_ID=$(echo "$EXISTING" | jq -r '.id')
              RESPONSE=$(curl -s -X PATCH \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"name\":\"$NAME\",\"body\":$BODY,\"draft\":$DRAFT,\"prerelease\":$PRERELEASE}" \
                https://api.github.com/repos/${REPO_FORK}/releases/$RELEASE_ID)
            fi

            RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')

            if [ "$RELEASE_ID" == "null" ]; then
               echo "‚ùå Error creating/updating release. Server response:"
               echo "$RESPONSE"
               continue
            fi

            echo "‚¨áÔ∏è Syncing assets for $TAG (Release ID: $RELEASE_ID)‚Ä¶"
            
            # Asset Sync Loop
            echo "$rel" | jq -c '.assets[]?' | while read asset; do
              ASSET_NAME=$(echo "$asset" | jq -r '.name')
              ASSET_URL=$(echo "$asset" | jq -r '.url')

              echo "   ‚Üí Downloading $ASSET_NAME"
              curl -L \
                -H "Authorization: token $TOKEN" \
                -H "Accept: application/octet-stream" \
                "$ASSET_URL" -o "$ASSET_NAME"

              echo "   ‚Üí Uploading $ASSET_NAME to fork release $TAG"
              curl -s -X POST \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$ASSET_NAME" \
                "https://uploads.github.com/repos/${REPO_FORK}/releases/$RELEASE_ID/assets?name=$ASSET_NAME"
                
              rm -f "$ASSET_NAME"
            done

          done

          echo "üéâ Finished syncing latest releases!"
